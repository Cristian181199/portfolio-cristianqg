---
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../../i18n/utils';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/es/blog');
}

const entry = await getEntry('blog', slug);

if (!entry || entry.data.draft || entry.data.lang !== 'es') {
  return Astro.redirect('/es/blog');
}

const { Content } = await entry.render();

const lang = entry.data.lang;
const t = useTranslations(lang);

function calculateReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

const readingTime = calculateReadingTime(entry.body);
---

<BaseLayout title={`${entry.data.title} - ${t('hero.name')}`} description={entry.data.description} lang={lang}>
  <article class="container mx-auto px-4 py-12 max-w-4xl">
    <a href={getLocalizedPath('/blog', lang)} class="inline-flex items-center text-[var(--color-primary)] hover:underline mb-8">
      ← {t('blog.backToBlog')}
    </a>
    
    <header class="mb-12">
      <h1 class="text-5xl font-bold mb-4">{entry.data.title}</h1>
      
      <div class="flex items-center space-x-4 text-[var(--text-secondary)] mb-6">
        <time datetime={entry.data.pubDate.toISOString()}>
          {entry.data.pubDate.toLocaleDateString(lang, {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
        <span>•</span>
        <span>{readingTime} {t('blog.readingTime')}</span>
      </div>
      
      {entry.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {entry.data.tags.map((tag) => (
            <span class="px-3 py-1 bg-[var(--color-primary)]/10 text-[var(--color-primary)] rounded-full text-sm">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>
    
    <div class="prose prose-lg max-w-none dark:prose-invert">
      <Content />
    </div>
  </article>
</BaseLayout>
